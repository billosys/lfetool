#!/bin/bash

template="templates/lfetool/lfetool.tmpl"
temp="lfetool-temp"
dest="lfetool"


fill-tool-var () {
    template=$1
    pattern=$2
    if [ "$pattern" = "" ]; then
        pattern="{{NOOP}}"
    fi
    data=`cat "$template" | base64`
    # DEBUG
    #echo $template
    #echo $pattern
    #echo $data
    sed -e "s#$pattern#$data#g" $dest > $temp
    mv $temp $dest
}

fill-usage () {
    template="templates/lfetool/usage.txt.tmpl"
    pattern="{{USAGE}}"
    fill-tool-var $template $pattern
}

fill-common-files () {
    # ignores
    template="templates/common/.gitignore.tmpl"
    pattern="{{GITIGNORE}}"
    fill-tool-var $template $pattern
    # expm package file
    template="templates/common/package.exs.tmpl"
    pattern="{{PACKAGE}}"
    fill-tool-var $template $pattern
    # rebar config file
    template="templates/common/rebar.config.tmpl"
    pattern="{{REBAR}}"
    fill-tool-var $template $pattern
    # Travis CI file
    template="templates/common/.travis.yml.tmpl"
    pattern="{{TRAVISCI}}"
    fill-tool-var $template $pattern
    # README file
    template="templates/common/README.rst.tmpl"
    pattern="{{README}}"
    fill-tool-var $template $pattern
}

fill-makefiles () {
    # base make include
    template="templates/common/common.mk.tmpl"
    pattern="{{COMMONMK}}"
    fill-tool-var $template $pattern
    # otp make include
    template="templates/service/otp.mk.tmpl"
    pattern="{{OTPMK}}"
    fill-tool-var $template $pattern
    # yaws make include
    template="templates/yaws/yaws.mk.tmpl"
    pattern="{{YAWSMK}}"
    fill-tool-var $template $pattern
    # master make file for library projects
    template="templates/library/Makefile.tmpl"
    pattern="{{LIBMAKEFILE}}"
    fill-tool-var $template $pattern
    # master make file for service projects
    template="templates/service/Makefile.tmpl"
    pattern="{{SVCMAKEFILE}}"
    fill-tool-var $template $pattern
    # master make file for yaws projects
    template="templates/yaws/Makefile.tmpl"
    pattern="{{YAWSMAKEFILE}}"
    fill-tool-var $template $pattern
}

fill-script () {
    template="templates/script/SCRIPT.tmpl"
    pattern="{{SCRIPTFILE}}"
    fill-tool-var $template $pattern
}

fill-library-files () {
    # app.src file
    template="templates/library/PROJECT.app.src.tmpl"
    pattern="{{LIBAPPSRC}}"
    fill-tool-var $template $pattern
    # test module
    template="templates/common/PROJECT-tests.lfe.tmpl"
    pattern="{{LIBTESTMODULE}}"
    fill-tool-var $template $pattern
    # module
    template="templates/common/PROJECT.lfe.tmpl"
    pattern="{{LIBMODULE}}"
    fill-tool-var $template $pattern
}

fill-service-files () {
    # app.src file
    template="templates/service/PROJECT.app.src.tmpl"
    pattern="{{SVCAPPSRC}}"
    fill-tool-var $template $pattern
    # test module
    template="templates/service/PROJECT-tests.lfe.tmpl"
    pattern="{{SVCTESTMODULE}}"
    fill-tool-var $template $pattern
    # server module
    template="templates/service/PROJECT-server.lfe.tmpl"
    pattern="{{SVCSERVER}}"
    fill-tool-var $template $pattern
    # supervisor
    template="templates/service/PROJECT-sup.lfe.tmpl"
    pattern="{{SVCSUP}}"
    fill-tool-var $template $pattern
    # app
    template="templates/service/PROJECT-app.lfe.tmpl"
    pattern="{{SVCAPP}}"
    fill-tool-var $template $pattern
}

fill-yawsmodules () {
    # yaws conf
    template="templates/yaws/yaws.conf.tmpl"
    pattern="{{YAWSCONF}}"
    fill-tool-var $template $pattern
    # yaws rebar
    template="templates/yaws/rebar.config.tmpl"
    pattern="{{YAWSREBAR}}"
    fill-tool-var $template $pattern
    # entry point module
    template="templates/yaws/PROJECT.lfe.tmpl"
    pattern="{{YAWSMODULE}}"
    fill-tool-var $template $pattern
    # routes module
    template="templates/yaws/PROJECT-routes.lfe.tmpl"
    pattern="{{YAWSROUTESMODULE}}"
    fill-tool-var $template $pattern
    # content module
    template="templates/yaws/PROJECT-content.lfe.tmpl"
    pattern="{{YAWSCONTENTMODULE}}"
    fill-tool-var $template $pattern
    # util module
    template="templates/yaws/PROJECT-util.lfe.tmpl"
    pattern="{{YAWSUTILMODULE}}"
    fill-tool-var $template $pattern
}

run () {
    cp $template $dest
    fill-usage
    fill-commoon-files
    fill-makefiles
    fill-script
    fill-library-files
    fill-service-files
    fill-yaws-files
    chmod 755 $dest
}

run
