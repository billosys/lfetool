#!/bin/bash

version=0.2.2
tooltemplate="plugins/lfetool/templates/lfetool.tmpl"
compresstemplate="plugins/lfetool/templates/compressed.tmpl"
temp="lfetool-temp"
dest="lfetool"

# load all the fillers from the plugins
for FILE in `ls plugins/*/filler.sh`; do
    source $FILE
done

# substitute template patterns with values
fill-tool-var () {
    local template=$1
    local pattern=$2
    if [ "$pattern" = "" ]; then
        pattern="{{NOOP}}"
    fi
    data=`cat "$template" | base64`
    # DEBUG
    #echo $template
    #echo $pattern
    #echo $data
    sed -e "s#$pattern#$data#g" $dest > $temp
    mv $temp $dest
}

fill-templates () {
    cp $tooltemplate $dest
    fill-lfetool-files
    fill-common-files
    fill-script
    fill-library-files
    fill-service-files
    fill-yaws-files
    fill-yaws-bootstrap-files
}

compress-tool () {
    data=`gzip --best --stdout $dest|base64`
    cat << ENDSCRIPT >$temp
#!/usr/bin/env bash

version=$version
lfetool="$data"

decode () {
    os=`uname`
    case \$os in
        Darwin)
            base64 -D
            ;;
        *)
            base64 -d
            ;;
    esac
}

echo \$lfetool | decode | gzip -d --stdout | bash -s -- "\$@"
ENDSCRIPT
    mv $temp $dest
}

run () {
    fill-templates
    compress-tool
    chmod 755 $dest
}

run
