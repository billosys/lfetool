#!/usr/bin/env bash

version=0.3.0
tooltemplate="plugins/lfetool/templates/lfetool.tmpl"
compresstemplate="plugins/lfetool/templates/compressed.tmpl"
temp="lfetool-temp"
dest="lfetool"

# load all the fillers from the plugins
for FILE in `ls plugins/*/filler.sh`; do
    source $FILE
done

# substitute template patterns with values
fill-tool-var () {
    local template=$1
    local pattern=$2
    if [ "$pattern" = "" ]; then
        pattern="{{NOOP}}"
    fi
    data=`cat "$template" | base64`
    # DEBUG
    #echo $template
    #echo $pattern
    #echo $data
    sed -e "s#$pattern#$data#g" $dest > $temp
    mv $temp $dest
}

add-license () {
    awk '{printf "# %s\n", $0}' < LICENSE|sed -e 's/[ ]*$//g'
}

fill-templates () {
    cp $tooltemplate $dest
    fill-lfetool-files
    fill-common-files
    fill-script
    fill-library-files
    fill-service-files
    fill-yaws-files
    fill-yaws-bootstrap-files
    echo "`add-license`" > $temp
    cat $dest>>$temp
    mv $temp $dest
}

compress-tool () {
    data=`gzip --best --stdout $dest|base64`
    echo "#!/usr/bin/env bash" > $temp
    echo >> $temp
    echo "`add-license`" >> $temp
    echo >> $temp
    cat << ENDSCRIPT >> $temp
version=$version
lfetool="$data"

decode () {
    os=\`uname\`
    case \$os in
        Darwin)
            base64 -D
            ;;
        *)
            base64 -d
            ;;
    esac
}

uncompress () {
    echo \$lfetool | decode | gzip -d --stdout
}

run () {
    local script=\$0
    local command=\$1
    case \$command in
        -x)
            echo
            echo "Extracting file ..."
            tmp=/tmp/\`date "+%Y%d%m%H%M%S_lfetool"\`
            echo "#!/usr/bin/env bash" > \$tmp
            echo "" >> \$tmp
            echo "version=\$version" >> \$tmp
            echo "" >> \$tmp
            uncompress >> \$tmp
            chmod 755 \$tmp
            mv \$tmp \$script
            echo "Done."
            exit 0
            ;;
        extract)
            \$script -x
            ;;
        *)
            uncompress | bash -s -- \$script \$version \$@ \\
              && exit 0 \\
              || exit 1
            ;;
    esac
}

run \$@
ENDSCRIPT
    mv $temp $dest
}

run () {
    fill-templates
    compress-tool
    chmod 755 $dest
}

run
